import numpy as np
import yfinance as yf
import matplotlib.pyplot as plt

# Downloading stock data
ticker = "TSLA"
data = yf.download(ticker, start="2020-01-01", end="2025-01-01")
short_ma = 5
long_ma = 12
buy_fee = 0.000
sell_fee = 0.000
risk_free_rate = 0.02

# Coding technical analysis signals
data['MA' + str(short_ma)] = data['Close'].rolling(short_ma).mean()
data['MA' + str(long_ma)] = data['Close'].rolling(long_ma).mean()
data['return'] = data['Close'].pct_change()

# Simulating trading strategies
start = long_ma

# Signal: 1 for long, -1 for short, 0 for neutral
data['signal'] = 0
data.loc[data['MA' + str(short_ma)] > data['MA' + str(long_ma)], 'signal'] = 1
data.loc[data['MA' + str(short_ma)] < data['MA' + str(long_ma)], 'signal'] = -1

# Shift signal for realistic returns
shifted_signal = data['signal'].shift(1)[start+1:]
returns = data['return'][start+1:]

# Strategy return with long and short
strategy_return = returns * shifted_signal

# Identify transition points for applying fees
position_change = data['signal'].diff()[start+1:]
buy_signals = (position_change == 2)  # Short to long
sell_signals = (position_change == -2)  # Long to short

# Apply fees
strategy_return[buy_signals] -= buy_fee
strategy_return[sell_signals] -= sell_fee

# Cumulative returns
BnH_return = np.array(data['return'][start+1:])
BnH_cum_return = np.cumprod(1 + BnH_return)
MACD_cum_return = np.cumprod(1 + strategy_return)

# Annualized return & risk
BnH = np.prod(1+BnH_return)**(252/len(BnH_return)) - 1
MACD = np.prod(1+strategy_return)**(252/len(strategy_return)) - 1
BnH_risk = np.std(BnH_return) * (252)**(1/2)
MACD_risk = np.std(strategy_return) * (252)**(1/2)

# Drawdown Calculation
def max_drawdown(returns):
    cum_returns = np.cumprod(1 + returns)
    peak = np.maximum.accumulate(cum_returns)
    drawdown = (cum_returns - peak) / peak
    return np.min(drawdown)  # Max drawdown is the lowest point

BnH_drawdown = max_drawdown(BnH_return)
MACD_drawdown = max_drawdown(strategy_return)

# Sharpe Ratio Calculation
def sharpe_ratio(returns, risk_free_rate):
    excess_return = np.mean(returns) - (risk_free_rate / 252)  # Daily risk-free rate
    return excess_return / np.std(returns) * np.sqrt(252)  # Annualized Sharpe ratio

BnH_sharpe = sharpe_ratio(BnH_return, risk_free_rate)
MACD_sharpe = sharpe_ratio(strategy_return, risk_free_rate)

# Visualizing the results
plt.figure(figsize=(12, 6))
plt.plot(np.arange(len(BnH_cum_return)), BnH_cum_return, label="Buy & Hold", color='blue')
plt.plot(np.arange(len(MACD_cum_return)), MACD_cum_return, label="Skew-Kurt Strategy (Long & Short)", color='red')
plt.xlabel("Days")
plt.ylabel("Cumulative Return")
plt.title("Buy & Hold vs. Skew-Kurt Long/Short Strategy (with Fees)")
plt.legend()
plt.grid()
plt.show()

# Printing results
print(f'Buy-and-hold strategy return and risk: {round(BnH*100,2)}% and {round(BnH_risk*100,2)}%, Max Drawdown: {BnH_drawdown*100:.2f}%, Sharpe Ratio: {BnH_sharpe:.2f}')
print(f'Skew-Kurt strategy return and risk: {round(MACD*100,2)}% and {round(MACD_risk*100,2)}%, Max Drawdown: {MACD_drawdown*100:.2f}%, Sharpe Ratio: {MACD_sharpe:.2f}')
